<html>
  <head>
    <script src="js/aframe.min.js"></script>
    <script src="js/socket.io.min.js"></script>
    <script src="easyrtc/easyrtc.js"></script>
    <script src="build.js"></script>

    <script src="js/aframe-randomizer-components.min.js"></script>
    <script src="js/aframe-physics-system.min.js"></script>
    <script src="js/aframe-extras.min.js"></script>

    <script>
      function randomPointOnCircle(radius, angleRad) {
        x = Math.cos(angleRad)*radius;
        y = Math.sin(angleRad)*radius;
        return {x: x, y: y};
      }

      // Define custom schema for syncing avatar color, set by random-color
      var avatarSchema = {
        template: '#avatar-template',
        components: [
          'position',
          'rotation',
          {
            selector: '.head',
            component: 'material'
          }
        ]
      };
      NAF.schemas.add(avatarSchema);

      // Called by Networked-Aframe when connected to server
      function onConnect () {
        if (!AFRAME.utils.isMobile() && AFRAME.utils.checkHeadsetConnected()) {
          // Get random angle
          var angleRad = 0;

          // Get position around a circle
          var positionStr = '0 ' + document.querySelector('#camera').getAttribute('position').y + ' 0';

          var rotationStr = '0 0 0';

          /*var leftHandNAF = NAF.entities.createNetworkEntity('#hand-template', '0 0 0', '0 0 0');
          var leftHandEl = document.getElementById('hand-left');
          if (leftHandEl.children.length == 0) {
            console.log('NAF: ', leftHandEl);
            leftHandEl.appendChild(leftHandNAF);
          }

          var rightHandNAF = NAF.entities.createNetworkEntity('#hand-template', '0 0 0', '0 0 0');
          var rightHandEl = document.getElementById('hand-right');

          //if (rightHandEl.children.length == 0) {
            //rightHandEl.appendChild(rightHandNAF);
          //}*/

        } else {
          // Get random angle
          var angleRad = Math.random()*Math.PI*2;

          // Get position around a circle
          var position = randomPointOnCircle(3, angleRad);
          var positionStr = position.x + ' 1.3 ' + position.y;

          // Get rotation towards center of circle
          var angleDeg = angleRad * 180 / Math.PI;
          var angleToCenter = -1 * angleDeg + 90;
          var rotationStr = '0 ' + angleToCenter + ' 0';
        }
        

        // Create avatar with this position and rotation
        NAF.entities.createAvatar('#avatar-template', positionStr, rotationStr);
      }
    </script>
  </head>
  <body>

    <a-scene network-scene="
      room: basic;
      debug: true;
      audio: false;
    " physics="debug: true; gravity: -9.8;">
      <a-assets>
        <a-asset-item id="coffeemachine-obj" src="models/aliencoffeemachine.obj"></a-asset-item>
        <a-asset-item id="coffeemachine-mtl" src="models/aliencoffeemachine.mtl"></a-asset-item>
        <a-mixin id="coffeemachine" obj-model="obj: #coffeemachine-obj; mtl: #coffeemachine-mtl"></a-mixin>
        <a-asset-item id="holder-obj" src="models/holder.obj"></a-asset-item>
        <a-asset-item id="holder-mtl" src="models/holder.mtl"></a-asset-item>
        <a-mixin id="holder" obj-model="obj: #holder-obj; mtl: #holder-mtl"></a-mixin>
        <a-asset-item id="cup-obj" src="models/cup.obj"></a-asset-item>
        <a-asset-item id="cup-mtl" src="models/cup.mtl"></a-asset-item>
        <a-mixin id="cup" obj-model="obj: #cup-obj; mtl: #cup-mtl" scale="0.06 0.06 0.06"></a-mixin>

        <!-- Templates -->

        <!-- Avatar -->
        <script id="avatar-template" type="text/html">
          <a-entity class="avatar">
            <a-sphere class="head"
              color="#5985ff"
              scale="0.45 0.6 0.3"
              random-color
            ></a-sphere>
            <a-entity class="face"
              position="0 0.05 0"
            >
              <a-sphere class="eye"
                color="#000"
                position="0.16 0.1 -0.32"
                scale="0.1 0.18 0.03"
              >
                <a-sphere class="pupil"
                  color="#000"
                  position="0 -0.3 -1"
                  scale="0.12 0.2 0.1"
                  random-color
                >
                  <a-animation attribute="scale" dur="1000" from="0.12 0.2 0.1" to="0.12 0 0.1" repeat="indefinite" direction="alternate"></a-animation>
                </a-sphere>
              </a-sphere>
              <a-sphere class="eye"
                color="#000"
                position="-0.16 0.1 -0.32"
                scale="0.12 0.2 0.04"
              >
                <a-sphere class="pupil"
                  color="#000"
                  position="0 -0.3 -1"
                  scale="0.12 0.2 0.1"
                  random-color
                >
                  <a-animation attribute="scale" dur="1000" from="0.12 0.2 0.1" to="0.12 0 0.1" repeat="indefinite" direction="alternate"></a-animation>
                </a-sphere>
              </a-sphere>
            </a-entity>
          </a-entity>
        </script>

        <script id="hand-template" type="text/html">
          <a-entity class="hand">
            <a-sphere></a-sphere>
          </a-entity>
        </script>

        <!-- /Templates -->
      </a-assets>

      <a-camera id="camera">
      </a-camera>

      <a-entity id="hand-left" static-body="shape: sphere; sphereRadius: 0.02;" hand-controls="left" sphere-collider="objects: .throwable" grab></a-entity>
      <a-entity id="hand-right" static-body="shape: sphere; sphereRadius: 0.02;" hand-controls="right" sphere-collider="objects: .throwable" grab></a-entity>

      <a-entity light="type: ambient; color: #BBB"></a-entity>
      <a-entity light="type: directional; color: #FFF; intensity: 0.8" position="-0.5 1 1"></a-entity>

      <a-entity geometry="primitive: cylinder; radius: 64; height: 0.1" material="color: #f60" static-body></a-entity>

      <a-entity id="coffeecounter" geometry="primitive: box; width: 6; height: 0.8" material="color: #333" position="0 0.4 0" static-body></a-entity>

      <a-entity id="coffeemachine-main" class="coffeemachine" mixin="coffeemachine" position="0 0.8 0" rotation="0 90 0" scale="0.3 0.3 0.3"></a-entity>
      <a-entity geometry="primitive: box; height: 1; width: 1" material="color: #fff; opacity: 0;" position="-0.38 1.16 0.13" scale="1.38 0.62 0.35" static-body></a-entity>
      <a-entity geometry="primitive: box; height: 1; width: 1" material="color: #fff; opacity: 0;" position="-0.38 0.95 -0.24" scale="1.38 -0.14 0.35" static-body></a-entity>

      <a-entity id="holder-left" class="holder" mixin="holder" position="-0.17 1.30 -0.27" rotation="0 270 0" scale="0.08 0.08 0.08" static-body></a-entity>
      <a-entity id="holder-right" class="holder" mixin="holder" position="-0.90 1.30 -0.27" rotation="0 270 0" scale="0.08 0.08 0.08" static-body></a-entity>
      <a-entity id="holder-main" class="holder" mixin="holder" position="0.5 0.8 0" rotation="0 270 0" scale="0.08 0.08 0.08" static-body></a-entity>
      <a-entity id="cup-main" class="throwable" mixin="cup" position="-1.26 0.86 -0.27" dynamic-body="shape: box;"></a-entity>
      <a-entity id="cup-main2" class="throwable" mixin="cup" position="-1.26 0.91 -0.27" dynamic-body="shape: box;"></a-entity>
      <a-entity id="cup-main3" class="throwable" mixin="cup" position="-1.26 0.96 -0.27" dynamic-body="shape: box;"></a-entity>
      <a-entity id="cup-main4" class="throwable" mixin="cup" position="-1.26 1.01 -0.27" dynamic-body="shape: box;"></a-entity>
      <a-entity id="cup-right" class="throwable" mixin="cup" position="-0.89 1.08 -0.28" dynamic-body="shape: box;"></a-entity>
    </a-scene>
  <body>
</html>